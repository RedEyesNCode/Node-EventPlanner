#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require("../app");
var debug = require("debug")("project1:server");
var http = require("http"); // Change 'http' to 'https'
var fs = require("fs");
const crypto = require("crypto");

const certificateString = `-----BEGIN CERTIFICATE-----
MIIE9zCCA9+gAwIBAgISBPEu2gvpQCQ+DajCTzuRcmxYMA0GCSqGSIb3DQEBCwUA
MDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQD
EwJSMzAeFw0yNDA0MjQxMzA5MTJaFw0yNDA3MjMxMzA5MTFaMBcxFTATBgNVBAMT
DG1lZ21hYjJiLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMwI
KkfglJztZS1oHJG29IDWbWQFXWkZm/8XuOpjvYF64D3nZhErmS+jjfmMBvnhxQJi
Qke7/1vGBSKjtOCbkcIJf8V71Y0hMXnbVmdFqxwnO+BUG+hgJ4fuUZ4yf9zEk8N/
pHkfN/2kx6Yn3KQP8LHtYhj8gPJqDzPuX+cNBomBVo57t3x6yNSPNyI4kOUJJJfR
DPWXo9vbgiJFXeFOIScnDsjj6DXpx890kev/eu5R6jSTeaTmBzmAAC6qkH5/oZwT
Ac3zyt8uSw5LTGOLC/bSI0QVxpOa8OwdLbQOd6+itq9kQs1vVspOjT53kKWuWxxe
i+BbPOZPAWK+s8k4wvUCAwEAAaOCAiAwggIcMA4GA1UdDwEB/wQEAwIFoDAdBgNV
HSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIwADAdBgNVHQ4E
FgQUWs7Icz0oWczdgBXk5p6I+DSOhicwHwYDVR0jBBgwFoAUFC6zF7dYVsuuUAlA
5h+vnYsUwsYwVQYIKwYBBQUHAQEESTBHMCEGCCsGAQUFBzABhhVodHRwOi8vcjMu
by5sZW5jci5vcmcwIgYIKwYBBQUHMAKGFmh0dHA6Ly9yMy5pLmxlbmNyLm9yZy8w
KQYDVR0RBCIwIIIMbWVnbWFiMmIuY29tghB3d3cubWVnbWFiMmIuY29tMBMGA1Ud
IAQMMAowCAYGZ4EMAQIBMIIBBAYKKwYBBAHWeQIEAgSB9QSB8gDwAHYASLDja9qm
RzQP5WoC+p0w6xxSActW3SyB2bu/qznYhHMAAAGPEHBk+wAABAMARzBFAiEAn7Kj
injK58CGZV/hAy/xJ1t4lzJsxvLBqLYAR15qAxoCID0jtCrg9/dWEiU0JkQWBJ/G
NaVRXspSFEHOpiMu2u0EAHYAGZgQcQnw1lIuMIDSnj9ku4NuKMz5D1KO7t/OSj8W
tMoAAAGPEHBlJQAABAMARzBFAiA9Ca0jG/5b8B1t4P90YoVFswW6k2rnPGllepjx
/6UxQwIhALMrAEQy0P17CjguszVY8xav6cNQsgQYLNSjLgm2ntBwMA0GCSqGSIb3
DQEBCwUAA4IBAQBkDjcB41s+GwsXRuDQ03OvhYknK4gC1rqXA1b2Wuw5qUaiONqi
F3J5qeJbMRcspcawwaGvujvVPRwKWGfnflp3jNjLO3Dxo1t4QAGkGMOMGvAMIB0S
6eJkN9dn8Os4HYG2uUEp0xQqTRLmQjCLZMxAf4td8GC1eNI4SkJ/AApU7cwF0zQ5
r2oEPmWY8OvpwoYYjfCqybupF+Tlb9HdPrt7472vnFKwwj777CpbXdp+K4Lm1AmC
6lQjG7nxOWOPCBpGv6xyjPcRIshHMPYxoAV4Vq43jN08qqPZpomRrqyGwTuL0Xrg
YulYEJREE3Nmk6BkxeevqQOwlTCx8zPOoOKj
-----END CERTIFICATE-----`;

const privateKeyString = `-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAzAgqR+CUnO1lLWgckbb0gNZtZAVdaRmb/xe46mO9gXrgPedm
ESuZL6ON+YwG+eHFAmJCR7v/W8YFIqO04JuRwgl/xXvVjSExedtWZ0WrHCc74FQb
6GAnh+5RnjJ/3MSTw3+keR83/aTHpifcpA/wse1iGPyA8moPM+5f5w0GiYFWjnu3
fHrI1I83IjiQ5Qkkl9EM9Zej29uCIkVd4U4hJycOyOPoNenHz3SR6/967lHqNJN5
pOYHOYAALqqQfn+hnBMBzfPK3y5LDktMY4sL9tIjRBXGk5rw7B0ttA53r6K2r2RC
zW9Wyk6NPneQpa5bHF6L4Fs85k8BYr6zyTjC9QIDAQABAoIBAQCK/+UOIsocPv72
+D6+Zs4cF/lecuk4eOH138tyo5CvbW7nvYWjnPg3pE1M/UCjbFQzU42kIUfO1hEZ
kD3h5xpd/uq1N7A8/agfRHaQ1L3F6FS6d5KrtRY5XPrts6m4VZP1VDhQ7BvRCTma
0P1YKCPqk7aJHz0Z6XeCAZwEZLNXaTYmzqE446xP258yAekHhrswxMWrBWhaF45B
xfDlmmGnBwlls/ugqA6vSJ3dwfFiOFpjwCYVwJqHqm2okDNPXiFZS8/TmhPsUDeV
PPVEbqYJGRV4hR3CZFA1Sru16q12OPiB/R/DlmsQRAabFcJq793ScF2rWiaIcaS0
mIJupH0BAoGBAPCWGLlhwARtbLeOsnChkRRGpKlS8jDZbSLUVYAVA2f8hEUF3tad
YYeHwNS4PxBcehBsxzNs8n3EUUBkC3eYmVItD2W68IEYrJ1cilVAWioiHBbVOrC2
GiSGT9CunWqps6heie++NLTEhcnFbVP1Q6muHukGQ5lBWVOErpMoFSmdAoGBANka
iEjgCKuc5QnAAuuwOlpmXZIaTaKImeac8l+6J4ucEXhFB7i4HY+7BeiO/OxzDfNl
8V9eB+bNLbWjGAi1XGvUlhya6hu7MuXDEQo2HN5kYXj/eAQpiyZuXO4yIM4VoVwM
YfOlXycwxQI6W02z74cr1t5eqE1ZIr1hrgRsn8s5AoGAHY8TcpNj+CdJmDPcEKKJ
JKiZSoR6ZS4Rjpnv91CdnoUT6zcRbeTgOrqfIoOQm/4AsUvsHZFhKbqZEQQ5tHP3
QnVu0tzo97OEYcEg7eB+M3cFZHjGQTfedmZaIBWUGarH/APBhscjyqHqniO3jv0v
VwWhnpe6bnXs96nxmPrvvrECgYEA2DjzmNj/6aNV/VLt1bxrMZOYB6YIwiKYXLTd
M/fb4NCsGYNuwEsmrfqPVOHsBrZEI7DZJ6kn53db2fY4PpwaEw7j/lNPbBUSCQEx
HGFueROyfGa7KjIR81GhXl4wi+/BCEMQ3y9JyGdrHt/uBUJ7Ab3ovwm5R2fKEKGT
RbbFowkCgYAI1qY0uU+lDrcr7DBM/n2wHymXtZjqJMcOuKiLgjld96/95fZd/W/t
P7t1zZdG+PlYgX04Lg4CZZUG2iJ7ZsIw3V19o4Dtw2sEjnBioCdWN1ieEbjB1qX0
zhE8K1ii8H2ar/mvuiYBH2UuG6DD9CXgo9zvHfDnkviq2Fq6FOK3gA==
-----END RSA PRIVATE KEY-----`;

const fullChain = `-----BEGIN CERTIFICATE-----
MIIFFjCCAv6gAwIBAgIRAJErCErPDBinU/bWLiWnX1owDQYJKoZIhvcNAQELBQAw
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMjAwOTA0MDAwMDAw
WhcNMjUwOTE1MTYwMDAwWjAyMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNTGV0J3Mg
RW5jcnlwdDELMAkGA1UEAxMCUjMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQC7AhUozPaglNMPEuyNVZLD+ILxmaZ6QoinXSaqtSu5xUyxr45r+XXIo9cP
R5QUVTVXjJ6oojkZ9YI8QqlObvU7wy7bjcCwXPNZOOftz2nwWgsbvsCUJCWH+jdx
sxPnHKzhm+/b5DtFUkWWqcFTzjTIUu61ru2P3mBw4qVUq7ZtDpelQDRrK9O8Zutm
NHz6a4uPVymZ+DAXXbpyb/uBxa3Shlg9F8fnCbvxK/eG3MHacV3URuPMrSXBiLxg
Z3Vms/EY96Jc5lP/Ooi2R6X/ExjqmAl3P51T+c8B5fWmcBcUr2Ok/5mzk53cU6cG
/kiFHaFpriV1uxPMUgP17VGhi9sVAgMBAAGjggEIMIIBBDAOBgNVHQ8BAf8EBAMC
AYYwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMBIGA1UdEwEB/wQIMAYB
Af8CAQAwHQYDVR0OBBYEFBQusxe3WFbLrlAJQOYfr52LFMLGMB8GA1UdIwQYMBaA
FHm0WeZ7tuXkAXOACIjIGlj26ZtuMDIGCCsGAQUFBwEBBCYwJDAiBggrBgEFBQcw
AoYWaHR0cDovL3gxLmkubGVuY3Iub3JnLzAnBgNVHR8EIDAeMBygGqAYhhZodHRw
Oi8veDEuYy5sZW5jci5vcmcvMCIGA1UdIAQbMBkwCAYGZ4EMAQIBMA0GCysGAQQB
gt8TAQEBMA0GCSqGSIb3DQEBCwUAA4ICAQCFyk5HPqP3hUSFvNVneLKYY611TR6W
PTNlclQtgaDqw+34IL9fzLdwALduO/ZelN7kIJ+m74uyA+eitRY8kc607TkC53wl
ikfmZW4/RvTZ8M6UK+5UzhK8jCdLuMGYL6KvzXGRSgi3yLgjewQtCPkIVz6D2QQz
CkcheAmCJ8MqyJu5zlzyZMjAvnnAT45tRAxekrsu94sQ4egdRCnbWSDtY7kh+BIm
lJNXoB1lBMEKIq4QDUOXoRgffuDghje1WrG9ML+Hbisq/yFOGwXD9RiX8F6sw6W4
avAuvDszue5L3sz85K+EC4Y/wFVDNvZo4TYXao6Z0f+lQKc0t8DQYzk1OXVu8rp2
yJMC6alLbBfODALZvYH7n7do1AZls4I9d1P4jnkDrQoxB3UqQ9hVl3LEKQ73xF1O
yK5GhDDX8oVfGKF5u+decIsH4YaTw7mP3GFxJSqv3+0lUFJoi5Lc5da149p90Ids
hCExroL1+7mryIkXPeFM5TgO9r0rvZaBFOvV2z0gp35Z0+L4WPlbuEjN/lxPFin+
HlUjr8gRsI3qfJOQFy/9rKIJR0Y/8Omwt/8oTWgy1mdeHmmjk7j1nYsvC9JSQ6Zv
MldlTTKB3zhThV1+XWYp6rjd5JW1zbVWEkLNxE7GJThEUG3szgBVGP7pSWTUTsqX
nLRbwHOoq7hHwg==
-----END CERTIFICATE-----`;



// var port = normalizePort(process.env.PORT || "4000");
const port = normalizePort(process.env.PORT || "4000");
app.set("port", port);

const privateKeyBuffer = Buffer.from(privateKeyString);
const certificateBuffer = Buffer.from(certificateString);

const options = {
  key: privateKeyBuffer,
  cert: certificateBuffer,
  ca: fullChain,
};

var server = http.createServer( app);

server.listen(port);
server.on("error", onError);
server.on("listening", onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== "listen") {
    throw error;
  }

  var bind = typeof port === "string" ? "Pipe " + port : "Port " + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case "EACCES":
      console.error(bind + " requires elevated privileges");
      process.exit(1);
      break;
    case "EADDRINUSE":
      console.error(bind + " is already in use");
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === "string" ? "pipe " + addr : "port " + addr.port;
  debug("Listening on " + bind);
}
